<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Async Computed + jQuery | atom-effect-jquery</title>
    <style>
      :root {
        --bg-body: #0f172a;
        --bg-card: #1e293b;
        --bg-input: #0f172a;
        --border-subtle: #334155;
        --border-focus: #3b82f6;
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --text-tertiary: #64748b;
        --accent-primary: #3b82f6;
        --status-idle: #64748b;
        --status-pending: #f59e0b;
        --status-resolved: #10b981;
        --status-rejected: #ef4444;
        --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --font-base: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
      }

      * { margin: 0; padding: 0; box-sizing: border-box; }

      body {
        font-family: var(--font-base);
        background: var(--bg-body);
        color: var(--text-primary);
        min-height: 100vh;
        padding: 4rem 2rem;
        line-height: 1.5;
      }

      .container { max-width: 800px; margin: 0 auto; }

      header { margin-bottom: 4rem; text-align: center; }

      h1 {
        font-size: 2.25rem;
        font-weight: 800;
        letter-spacing: -0.025em;
        margin-bottom: 0.75rem;
      }

      .subtitle {
        color: var(--text-secondary);
        font-size: 1.125rem;
        max-width: 600px;
        margin: 0 auto;
      }

      .badge {
        display: inline-flex;
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        margin-top: 1.5rem;
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent-primary);
        border: 1px solid rgba(59, 130, 246, 0.2);
      }

      .card {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border-subtle);
        box-shadow: var(--shadow-card);
      }

      .card-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .search-input {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        background: var(--bg-input);
        color: var(--text-primary);
        font-size: 1rem;
        font-family: inherit;
        transition: all 0.2s ease;
        margin-bottom: 1.5rem;
      }

      .search-input:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .search-input::placeholder { color: var(--text-tertiary); }

      /* Status */
      .status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
      }

      .status::before {
        content: '';
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      .status-idle { color: var(--status-idle); }
      .status-idle::before { background: var(--status-idle); }
      .status-pending { color: var(--status-pending); }
      .status-pending::before { background: var(--status-pending); }
      .status-resolved { color: var(--status-resolved); }
      .status-resolved::before { background: var(--status-resolved); }
      .status-rejected { color: var(--status-rejected); }
      .status-rejected::before { background: var(--status-rejected); }

      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(0,0,0,0.1);
        border-top-color: currentColor;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        display: inline-block;
      }

      @keyframes spin { to { transform: rotate(360deg); } }

      /* Results */
      .results-container { min-height: 120px; }

      .user-list { display: grid; gap: 0.75rem; }

      .user-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        background: rgba(15, 23, 42, 0.5);
        border-radius: 8px;
        border: 1px solid transparent;
        transition: all 0.2s;
      }

      .user-item:hover {
        border-color: var(--border-subtle);
        background: var(--bg-input);
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--border-subtle);
        overflow: hidden;
        flex-shrink: 0;
      }

      .user-avatar img { width: 100%; height: 100%; object-fit: cover; }

      .user-info { flex: 1; min-width: 0; }

      .user-name {
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.9375rem;
      }

      .user-email a {
        font-size: 0.8125rem;
        color: var(--text-tertiary);
        text-decoration: none;
        transition: color 0.2s;
      }

      .user-email a:hover { color: var(--accent-primary); }

      .empty-state {
        text-align: center;
        padding: 2.5rem 1rem;
        color: var(--text-tertiary);
      }

      .empty-state-icon { font-size: 2rem; margin-bottom: 0.75rem; }

      .error-message {
        padding: 1rem;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
        border-radius: 8px;
        color: var(--status-rejected);
      }

      /* Debug Panel */
      .debug-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }

      .debug-item {
        padding: 1rem;
        background: rgba(15, 23, 42, 0.5);
        border-radius: 8px;
      }

      .debug-label {
        font-size: 0.75rem;
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.25rem;
      }

      .debug-value {
        font-family: var(--font-mono);
        font-size: 1.25rem;
        color: var(--text-primary);
      }

      /* Code Block */
      .code-block {
        background: var(--bg-input);
        border-radius: 8px;
        padding: 1.5rem;
        font-family: var(--font-mono);
        font-size: 0.875rem;
        line-height: 1.7;
        overflow-x: auto;
        margin-bottom: 1.5rem;
      }

      .code-comment { color: var(--text-tertiary); }
      .code-keyword { color: #c792ea; }
      .code-function { color: #82aaff; }
      .code-string { color: #c3e88d; }
      .code-method { color: #ffcb6b; }

      .info-box {
        padding: 1.25rem;
        background: rgba(59, 130, 246, 0.05);
        border: 1px solid rgba(59, 130, 246, 0.1);
        border-radius: 8px;
      }

      .info-box-title {
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: var(--text-primary);
      }

      .info-box ul {
        list-style: none;
        display: grid;
        gap: 0.5rem;
      }

      .info-box li {
        padding-left: 1.5rem;
        position: relative;
        color: var(--text-secondary);
        font-size: 0.9375rem;
      }

      .info-box li::before {
        content: '‚Üí';
        position: absolute;
        left: 0;
        color: var(--accent-primary);
      }

      .info-box code {
        background: rgba(0, 0, 0, 0.2);
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-size: 0.8125rem;
      }

      footer {
        text-align: center;
        margin-top: 4rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border-subtle);
        color: var(--text-tertiary);
      }

      footer a {
        color: var(--accent-primary);
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Async Computed + jQuery</h1>
        <p class="subtitle">
          GitHub User Search powered by <code>atom-effect-jquery</code> ‚Äî 
          async computed with automatic state tracking, race condition handling
        </p>
        <span class="badge">atom-effect-jquery</span>
      </header>

      <!-- Search Card -->
      <div class="card">
        <div class="card-title">
          <span>üîç GitHub User Search</span>
          <span id="status-indicator" class="status status-idle">Idle</span>
        </div>

        <input
          type="text"
          id="search-input"
          class="search-input"
          placeholder="Search GitHub users... (min 2 characters)"
        />

        <div id="results-container" class="results-container">
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <p>Enter a search term to see results</p>
          </div>
        </div>
      </div>

      <!-- Debug Panel -->
      <div class="card">
        <div class="card-title">üìä Reactive State Debug</div>
        <div class="debug-grid">
          <div class="debug-item">
            <div class="debug-label">Search Count</div>
            <div id="search-count" class="debug-value">0</div>
          </div>
          <div class="debug-item">
            <div class="debug-label">Current State</div>
            <div id="current-state" class="debug-value">idle</div>
          </div>
          <div class="debug-item">
            <div class="debug-label">Result Count</div>
            <div id="result-count" class="debug-value">0</div>
          </div>
          <div class="debug-item">
            <div class="debug-label">Last Update</div>
            <div id="last-update" class="debug-value">-</div>
          </div>
        </div>
      </div>

      <!-- Code Example -->
      <div class="card">
        <div class="card-title">üí° How It Works (atom-effect-jquery)</div>
        
<pre class="code-block"><span class="code-comment">// State</span>
<span class="code-keyword">const</span> query = $.<span class="code-function">atom</span>(<span class="code-string">''</span>);
<span class="code-keyword">const</span> searchCount = $.<span class="code-function">atom</span>(<span class="code-string">0</span>);

<span class="code-comment">// Async Computed</span>
<span class="code-keyword">const</span> results = $.<span class="code-function">computed</span>(<span class="code-keyword">async</span> () => {
  <span class="code-keyword">if</span> (query.value.length < 2) <span class="code-keyword">return</span> [];
  <span class="code-keyword">const</span> res = <span class="code-keyword">await</span> <span class="code-function">fetch</span>(<span class="code-string">`...?q=${query.value}`</span>);
  <span class="code-keyword">return</span> res.<span class="code-function">json</span>();
}, { defaultValue: [] });

<span class="code-comment">// DOM Bindings</span>
$(<span class="code-string">'#search-input'</span>).<span class="code-method">atomVal</span>(query, { debounce: 300 });
$(<span class="code-string">'#search-count'</span>).<span class="code-method">atomText</span>(searchCount);

<span class="code-comment">// List Rendering</span>
$(<span class="code-string">'#results'</span>).<span class="code-method">atomList</span>(results, {
  key: u => u.id,
  render: u => <span class="code-string">`&lt;div&gt;${u.login}&lt;/div&gt;`</span>
});</pre>

        <div class="info-box">
          <div class="info-box-title">üéØ atom-effect-jquery Features</div>
          <ul>
            <li>
              <strong>jQuery Chaining</strong> ‚Äî <code>.atomText()</code>, <code>.atomVal()</code>, <code>.atomList()</code>
            </li>
            <li>
              <strong>Automatic Cleanup</strong> ‚Äî Effects automatically disposed when DOM is removed (prevents memory leaks)
            </li>
            <li>
              <strong>Two-way Binding</strong> ‚Äî Done in one line with <code>.atomVal(atom)</code>
            </li>
            <li>
              <strong>Zero Build</strong> ‚Äî Ready to use immediately with just 2 CDN lines
            </li>
            <li>
              <strong>Async Computed</strong> ‚Äî Automatic Promise handling + race condition prevention
            </li>
          </ul>
        </div>
      </div>

      <footer>
        <p>
          Built with
          <a href="https://github.com/but212/atom-effect-jquery" target="_blank">atom-effect-jquery</a>
        </p>
      </footer>
    </div>

    <!-- Dependencies -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="../dist/atom-effect-jquery.min.js"></script>
    
    <script>
      // ============================================================
      // State Definition
      // ============================================================
      const searchCount = $.atom(0);
      const debouncedQuery = $.atom('');
      let debounceTimer = null;

      // ============================================================
      // Async Computed - Handles race conditions automatically
      // ============================================================
      const searchResults = $.computed(
        async () => {
          const query = debouncedQuery.value;
          if (!query || query.trim().length < 2) return [];

          const response = await fetch(
            `https://api.github.com/search/users?q=${encodeURIComponent(query)}&per_page=5`
          );

          if (!response.ok) throw new Error(`API Error: ${response.status}`);
          
          const data = await response.json();
          return data.items || [];
        },
        { defaultValue: [] }
      );

      // ============================================================
      // Derived State
      // ============================================================
      const resultCount = $.computed(() => searchResults.value.length);

      const statusInfo = $.computed(() => {
        const state = searchResults.state;
        const query = debouncedQuery.value;

        switch (state) {
          case 'idle':
            return { text: 'Idle', class: 'status-idle', showSpinner: false };
          case 'pending':
            return { text: `Searching "${query}"...`, class: 'status-pending', showSpinner: true };
          case 'resolved':
            const count = searchResults.value.length;
            return { 
              text: count > 0 ? `${count} results found` : 'No results', 
              class: 'status-resolved',
              showSpinner: false 
            };
          case 'rejected':
            return { text: 'Error occurred', class: 'status-rejected', showSpinner: false };
          default:
            return { text: 'Unknown', class: 'status-idle', showSpinner: false };
        }
      });

      // ============================================================
      // DOM Bindings
      // ============================================================
      
      // Debug panel bindings
      $('#search-count').atomText(searchCount);
      $('#current-state').atomText($.computed(() => searchResults.state));
      $('#result-count').atomText(resultCount);

      // Status indicator - Complex DOM manipulation with effect
      $.effect(() => {
        const status = statusInfo.value;
        const $el = $('#status-indicator');
        
        $el.attr('class', `status ${status.class}`);
        
        if (status.showSpinner) {
          $el.html('<div class="spinner"></div> ' + status.text);
        } else {
          $el.text(status.text);
        }
      });

      // Results container
      $.effect(() => {
        const results = searchResults.value;
        const state = searchResults.state;
        const query = debouncedQuery.value;
        const $container = $('#results-container');

        // Adjust opacity only during pending state
        if (state === 'pending' && results.length > 0) {
          $container.css('opacity', '0.6');
          return;
        }

        $container.css('opacity', '1');

        // Empty state
        if (!query || query.length < 2) {
          $container.html(`
            <div class="empty-state">
              <div class="empty-state-icon">üîç</div>
              <p>Enter a search term to see results</p>
            </div>
          `);
          return;
        }

        // Error state
        if (searchResults.hasError) {
          $container.html(`
            <div class="error-message">
              ‚ö†Ô∏è ${searchResults.lastError?.message || 'Unknown error'}
            </div>
          `);
          return;
        }

        // No results
        if (results.length === 0 && state === 'resolved') {
          $container.html(`
            <div class="empty-state">
              <div class="empty-state-icon">ü§∑</div>
              <p>No results for "${query}"</p>
            </div>
          `);
          return;
        }

        // Render results
        const html = `
          <div class="user-list">
            ${results.map(user => `
              <div class="user-item">
                <div class="user-avatar">
                  <img src="${user.avatar_url}" alt="${user.login}" 
                       onerror="this.style.display='none'; this.parentNode.textContent='${user.login[0].toUpperCase()}'">
                </div>
                <div class="user-info">
                  <div class="user-name">${user.login}</div>
                  <div class="user-email">
                    <a href="${user.html_url}" target="_blank">${user.html_url}</a>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        $container.html(html);
      });

      // Last update time
      $.effect(() => {
        if (searchResults.state === 'resolved') {
          $('#last-update').text(new Date().toLocaleTimeString());
        }
      });

      // ============================================================
      // Event Handling - debounce
      // ============================================================
      $('#search-input').on('input', function() {
        const value = $(this).val();
        
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          if (value.trim().length >= 2) {
            searchCount.value++;
          }
          debouncedQuery.value = value;
        }, 300);
      });

      // Focus on load
      $('#search-input').focus();
    </script>
  </body>
</html>