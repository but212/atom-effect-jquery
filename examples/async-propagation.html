<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Async Propagation | No More Callback Hell</title>
    <!-- jQuery First -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- atom-effect-jquery -->
    <script src="https://cdn.jsdelivr.net/npm/atom-effect-jquery@0.6.1"></script>
    <style>
      :root {
        --bg-body: #0a0a0f;
        --bg-card: #12121a;
        --bg-code: #0d0d12;
        --bg-input: #0f0f14;
        
        --border-subtle: #1f1f2e;
        --border-focus: #6366f1;
        
        --text-primary: #f0f0f5;
        --text-secondary: #8b8b9e;
        --text-tertiary: #5c5c70;
        
        --accent-primary: #6366f1;
        --accent-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        
        --status-idle: #5c5c70;
        --status-pending: #eab308;
        --status-resolved: #22c55e;
        --status-rejected: #ef4444;
        
        --callback-hell: #ef4444;
        --declarative: #22c55e;

        --font-base: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        --font-mono: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
      }

      * { margin: 0; padding: 0; box-sizing: border-box; }

      body {
        font-family: var(--font-base);
        background: var(--bg-body);
        color: var(--text-primary);
        min-height: 100vh;
        padding: 3rem 1.5rem;
        line-height: 1.6;
      }

      .container { max-width: 1100px; margin: 0 auto; }

      /* Header */
      header { 
        text-align: center; 
        margin-bottom: 3rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid var(--border-subtle);
      }
      
      .badge {
        display: inline-block;
        background: var(--accent-gradient);
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      
      h1 { 
        font-size: 2.5rem; 
        font-weight: 800; 
        margin-bottom: 0.75rem; 
        letter-spacing: -0.03em;
        background: linear-gradient(to right, #f0f0f5, #8b8b9e);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      
      .subtitle { 
        color: var(--text-secondary); 
        font-size: 1.125rem;
        max-width: 600px; 
        margin: 0 auto; 
      }

      /* Section */
      .section {
        margin-bottom: 3rem;
      }
      
      .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      
      .section-title .icon {
        font-size: 1.5rem;
      }

      /* Code Comparison */
      .comparison-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
      }
      
      @media (max-width: 900px) {
        .comparison-grid { grid-template-columns: 1fr; }
      }

      .code-card {
        background: var(--bg-card);
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid var(--border-subtle);
      }
      
      .code-header {
        padding: 1rem 1.25rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--border-subtle);
      }
      
      .code-header h3 {
        font-size: 0.9375rem;
        font-weight: 600;
      }
      
      .code-tag {
        font-size: 0.6875rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
      }
      
      .code-tag.bad {
        background: rgba(239, 68, 68, 0.15);
        color: var(--callback-hell);
      }
      
      .code-tag.good {
        background: rgba(34, 197, 94, 0.15);
        color: var(--declarative);
      }

      .code-body {
        padding: 1.25rem;
        font-family: var(--font-mono);
        font-size: 0.8125rem;
        line-height: 1.7;
        overflow-x: auto;
        background: var(--bg-code);
      }
      
      .code-body pre {
        margin: 0;
        white-space: pre;
      }

      /* Syntax Highlighting */
      .code-keyword { color: #c084fc; }
      .code-fn { color: #60a5fa; }
      .code-comment { color: #4a4a5e; font-style: italic; }
      .code-str { color: #4ade80; }
      .code-err { color: #f87171; }
      .code-num { color: #fbbf24; }
      .code-prop { color: #67e8f9; }
      .indent { display: inline-block; }

      /* Problems List */
      .problems-list {
        margin-top: 1rem;
        padding: 1rem 1.25rem;
        background: rgba(239, 68, 68, 0.05);
        border-top: 1px solid rgba(239, 68, 68, 0.2);
      }
      
      .problems-list li {
        color: var(--text-secondary);
        font-size: 0.8125rem;
        margin-bottom: 0.5rem;
        list-style: none;
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .problems-list li::before {
        content: 'âœ—';
        color: var(--callback-hell);
        font-weight: bold;
      }

      /* Benefits List */
      .benefits-list {
        margin-top: 1rem;
        padding: 1rem 1.25rem;
        background: rgba(34, 197, 94, 0.05);
        border-top: 1px solid rgba(34, 197, 94, 0.2);
      }
      
      .benefits-list li {
        color: var(--text-secondary);
        font-size: 0.8125rem;
        margin-bottom: 0.5rem;
        list-style: none;
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .benefits-list li::before {
        content: 'âœ“';
        color: var(--declarative);
        font-weight: bold;
      }

      /* Live Demo Card */
      .demo-card {
        background: var(--bg-card);
        border-radius: 16px;
        border: 1px solid var(--border-subtle);
        overflow: hidden;
      }
      
      .demo-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      
      .demo-header h3 {
        font-size: 1rem;
        font-weight: 600;
      }
      
      .demo-controls {
        display: flex;
        gap: 0.75rem;
      }

      .btn {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.8125rem;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        font-family: inherit;
      }

      .btn-success {
        background: rgba(34, 197, 94, 0.1);
        color: #4ade80;
        border-color: rgba(34, 197, 94, 0.3);
      }
      .btn-success:hover { 
        background: rgba(34, 197, 94, 0.2); 
        transform: translateY(-1px); 
      }

      .btn-fail {
        background: rgba(239, 68, 68, 0.1);
        color: #f87171;
        border-color: rgba(239, 68, 68, 0.3);
      }
      .btn-fail:hover { 
        background: rgba(239, 68, 68, 0.2); 
        transform: translateY(-1px); 
      }

      /* Pipeline Visualization */
      .pipeline {
        padding: 2rem 1.5rem;
        display: flex;
        align-items: stretch;
        gap: 0;
        position: relative;
        background: var(--bg-code);
      }
      
      .pipeline-stage {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
      }
      
      .pipeline-stage:not(:last-child)::after {
        content: 'â†’';
        position: absolute;
        right: -0.75rem;
        top: 2.5rem;
        font-size: 1.25rem;
        color: var(--border-subtle);
        z-index: 2;
      }
      
      .pipeline-stage.active::after { color: var(--status-pending); }
      .pipeline-stage.resolved::after { color: var(--status-resolved); }
      .pipeline-stage.rejected::after { color: var(--status-rejected); }

      .stage-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 1rem;
        margin: 0 0.5rem;
        transition: all 0.3s ease;
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      
      .stage-card.active { 
        border-color: var(--status-pending); 
        box-shadow: 0 0 20px rgba(234, 179, 8, 0.1);
      }
      
      .stage-card.resolved { 
        border-color: var(--status-resolved);
      }
      
      .stage-card.rejected { 
        border-color: var(--status-rejected);
        background: rgba(239, 68, 68, 0.05);
      }

      .stage-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
      }
      
      .stage-name {
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--text-primary);
      }
      
      .stage-badge {
        font-size: 0.625rem;
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }
      
      .stage-badge.idle { background: var(--bg-body); color: var(--status-idle); }
      .stage-badge.pending { background: rgba(234, 179, 8, 0.15); color: var(--status-pending); }
      .stage-badge.resolved { background: rgba(34, 197, 94, 0.15); color: var(--status-resolved); }
      .stage-badge.rejected { background: rgba(239, 68, 68, 0.15); color: var(--status-rejected); }

      .stage-desc {
        font-size: 0.75rem;
        color: var(--text-tertiary);
        margin-bottom: 0.75rem;
      }

      .stage-output {
        margin-top: auto;
        font-family: var(--font-mono);
        font-size: 0.75rem;
        padding: 0.625rem;
        background: var(--bg-body);
        border-radius: 6px;
        color: var(--text-secondary);
        min-height: 2.5rem;
        display: flex;
        align-items: center;
        word-break: break-all;
      }
      
      .stage-output.error {
        color: var(--status-rejected);
      }

      .spinner {
        width: 10px; height: 10px;
        border: 2px solid currentColor; 
        border-top-color: transparent;
        border-radius: 50%; 
        animation: spin 0.7s linear infinite;
        margin-right: 0.5rem;
        display: inline-block;
      }
      
      @keyframes spin { to { transform: rotate(360deg); } }

      /* Key Insight */
      .insight-box {
        margin-top: 1.5rem;
        padding: 1.25rem 1.5rem;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 12px;
      }
      
      .insight-title {
        font-size: 0.875rem;
        font-weight: 700;
        color: var(--accent-primary);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .insight-text {
        font-size: 0.875rem;
        color: var(--text-secondary);
        line-height: 1.6;
      }
      
      .insight-text code {
        background: rgba(0,0,0,0.3);
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-family: var(--font-mono);
        font-size: 0.8125rem;
        color: var(--text-primary);
      }

      /* Footer */
      footer {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border-subtle);
        text-align: center;
        color: var(--text-tertiary);
        font-size: 0.875rem;
      }
      
      footer a {
        color: var(--accent-primary);
        text-decoration: none;
      }
      
      footer a:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <span class="badge">Paradigm Shift</span>
        <h1>No More Callback Hell</h1>
        <p class="subtitle">See how declarative async chains eliminate nested callbacks and manual error handling</p>
      </header>

      <!-- Before/After Comparison -->
      <section class="section">
        <h2 class="section-title">
          <span class="icon">âš¡</span>
          The Problem vs The Solution
        </h2>
        
        <div class="comparison-grid">
          <!-- BEFORE: Callback Hell -->
          <div class="code-card">
            <div class="code-header">
              <h3>Traditional Approach</h3>
              <span class="code-tag bad">Callback Hell</span>
            </div>
            <div class="code-body">
<pre><span class="code-fn">fetchUser</span>(userId, (err, user) => {
  <span class="code-keyword">if</span> (err) {
    <span class="code-fn">showError</span>(<span class="code-str">"User fetch failed"</span>);
    <span class="code-keyword">return</span>;
  }
  
  <span class="code-fn">fetchRepos</span>(user.login, (err, repos) => {
    <span class="code-keyword">if</span> (err) {
      <span class="code-fn">showError</span>(<span class="code-str">"Repos fetch failed"</span>);
      <span class="code-keyword">return</span>;
    }
    
    <span class="code-fn">calculateStats</span>(repos, (err, stats) => {
      <span class="code-keyword">if</span> (err) {
        <span class="code-fn">showError</span>(<span class="code-str">"Stats calc failed"</span>);
        <span class="code-keyword">return</span>;
      }
      
      <span class="code-fn">renderDashboard</span>(user, stats);
    });
  });
});</pre>
            </div>
            <ul class="problems-list">
              <li>Deeply nested callbacks ("pyramid of doom")</li>
              <li>Error handling repeated at every level</li>
              <li>Hard to understand control flow</li>
              <li>Re-running the chain requires rewriting logic</li>
            </ul>
          </div>

          <!-- AFTER: Declarative -->
          <div class="code-card">
            <div class="code-header">
              <h3>atom-effect-jquery Approach</h3>
              <span class="code-tag good">Declarative</span>
            </div>
            <div class="code-body">
<pre><span class="code-comment">// 1. Define Async Computed</span>
<span class="code-keyword">const</span> user = <span class="code-fn">$.computed</span>(<span class="code-keyword">async</span> () => {
  <span class="code-keyword">return await</span> <span class="code-fn">fetchUser</span>(userId.value);
});

<span class="code-comment">// 2. Bind UI with Effects</span>
<span class="code-fn">$.effect</span>(() => {
  <span class="code-keyword">const</span> state = user.state;
  
  <span class="code-comment">// Declarative UI Updates</span>
  <span class="code-keyword">if</span> (state === <span class="code-str">'pending'</span>) {
    $(<span class="code-str">'#badge'</span>).<span class="code-fn">text</span>(<span class="code-str">'Loading...'</span>);
  } <span class="code-keyword">else if</span> (state === <span class="code-str">'resolved'</span>) {
    $(<span class="code-str">'#badge'</span>).<span class="code-fn">text</span>(<span class="code-str">'Done'</span>);
    $(<span class="code-str">'#output'</span>).<span class="code-fn">text</span>(user.value.name);
  }
});</pre>
            </div>
            <ul class="benefits-list">
              <li>Flat, readable async flows</li>
              <li>Full control via <code>$.effect</code></li>
              <li>Automatic dependency tracking</li>
              <li>Built-in <code>state</code>, <code>value</code>, <code>error</code> handling</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- Live Demo -->
      <section class="section">
        <h2 class="section-title">
          <span class="icon">ðŸŽ®</span>
          Live Demo: GitHub Stats Pipeline
        </h2>
        
        <div class="demo-card">
          <div class="demo-header">
            <h3>Async Pipeline Visualization</h3>
            <div class="demo-controls">
              <button id="btnSuccess" class="btn btn-success">â–¶ Run Pipeline</button>
              <button id="btnFail" class="btn btn-fail">ðŸ’¥ Simulate API Error</button>
            </div>
          </div>
          
          <div class="pipeline">
            <div id="stage1" class="pipeline-stage">
              <div class="stage-card">
                <div class="stage-header">
                  <span class="stage-name">1. Fetch User</span>
                  <span id="badge1" class="stage-badge idle">Idle</span>
                </div>
                <div class="stage-desc">GET /users/:username</div>
                <div id="output1" class="stage-output">â€”</div>
              </div>
            </div>
            
            <div id="stage2" class="pipeline-stage">
              <div class="stage-card">
                <div class="stage-header">
                  <span class="stage-name">2. Fetch Repos</span>
                  <span id="badge2" class="stage-badge idle">Idle</span>
                </div>
                <div class="stage-desc">GET /users/:login/repos</div>
                <div id="output2" class="stage-output">â€”</div>
              </div>
            </div>
            
            <div id="stage3" class="pipeline-stage">
              <div class="stage-card">
                <div class="stage-header">
                  <span class="stage-name">3. Calculate Stats</span>
                  <span id="badge3" class="stage-badge idle">Idle</span>
                </div>
                <div class="stage-desc">Aggregate star count</div>
                <div id="output3" class="stage-output">â€”</div>
              </div>
            </div>
          </div>
          
          <div class="insight-box">
            <div class="insight-title">
              ðŸ’¡ Key Insight: Error Awareness Through hasError
            </div>
            <p class="insight-text">
              When <strong>Stage 2</strong> fails, <strong>Stage 3 detects it via <code>hasError</code></strong>.<br><br>
              The <code>hasError</code> property propagates through the dependency chain, allowing 
              downstream computeds to know if any upstream has failed.<br><br>
              <strong>No re-throwing needed â€” just check <code>hasError</code> to detect blocked states.</strong>
            </p>
          </div>
        </div>
      </section>

      <footer>
        <p>
          Built with <a href="https://github.com/but212/atom-effect-jquery">atom-effect-jquery</a> â€” 
          Reactive jQuery bindings for async-first applications
        </p>
      </footer>
    </div>

    <script>
      const AsyncState = {
        IDLE: 'idle',
        PENDING: 'pending',
        RESOLVED: 'resolved',
        REJECTED: 'rejected'
      };

      // --- Helpers ---
      const delay = (ms) => new Promise(r => setTimeout(r, ms));
      
      // Simulated API responses
      const mockUser = { login: 'octocat', name: 'The Octocat', id: 583231 };
      const mockRepos = [
        { name: 'Hello-World', stargazers_count: 2500 },
        { name: 'Spoon-Knife', stargazers_count: 12000 },
        { name: 'octocat.github.io', stargazers_count: 340 }
      ];

      // --- Reactive State ---
      const runId = $.atom(0);
      const shouldFail = $.atom(false);

      // --- Async Pipeline --
      
      // Stage 1: Fetch User
      const user = $.computed(async () => {
        const id = runId.value;
        if (id === 0) return null;
        
        await delay(800); // Simulate network latency
        return mockUser;
      }, { defaultValue: null });

      // Stage 2: Fetch Repos (depends on user, may fail)
      const repos = $.computed(async () => {
        const userData = user.value;
        if (!userData) return null;
        
        await delay(800);
        
        // Simulate API failure
        if (shouldFail.value) {
          throw new Error('API Rate Limit Exceeded');
        }
        
        return mockRepos;
      }, { defaultValue: null });

      // Stage 3: Stats
      const stats = $.computed(async () => {
        const repoList = repos.value;
        if (!repoList) return null;
        
        await delay(600);
        
        const totalStars = repoList.reduce((sum, r) => sum + r.stargazers_count, 0);
        const avgStars = Math.round(totalStars / repoList.length);
        
        return { totalStars, avgStars, repoCount: repoList.length };
      }, { defaultValue: null });

      // --- UI Bindings (Using $.effect for explicit control) ---
      
      const stages = [
        { id: '1', computed: user, format: (v) => v ? `${v.name} (@${v.login})` : 'â€”' },
        { id: '2', computed: repos, format: (v) => v ? `${v.length} repositories loaded` : 'â€”' },
        { id: '3', computed: stats, format: (v) => v ? `â­ ${v.totalStars.toLocaleString()} total (${v.repoCount} repos)` : 'â€”' }
      ];

      stages.forEach(({ id, computed: c, format }) => {
        const $stage = $(`#stage${id}`);
        const $card = $stage.find('.stage-card');
        const $badge = $(`#badge${id}`);
        const $output = $(`#output${id}`);

        $.effect(() => {
          const state = c.state;
          const value = c.value;
          const error = c.lastError;
          const hasUpstreamError = c.hasError && !error;

          // Reset classes
          $stage.removeClass('active resolved rejected');
          $card.removeClass('active resolved rejected');
          $badge.removeClass('idle pending resolved rejected');
          $output.removeClass('error');

          // Handle states with a switch for clarity
          switch (state) {
            case AsyncState.IDLE:
              $badge.addClass('idle').text('Idle');
              $output.text('â€”');
              break;

            case AsyncState.PENDING:
              $stage.addClass('active');
              $card.addClass('active');
              $badge.addClass('pending').text('Loading');
              $output.html('<span class="spinner"></span>Fetching...');
              break;

            case AsyncState.REJECTED:
              $stage.addClass('rejected');
              $card.addClass('rejected');
              $badge.addClass('rejected').text('Failed');
              $output.addClass('error').text(`â›” ${error?.message || 'Error'}`);
              break;

            case AsyncState.RESOLVED:
              if (hasUpstreamError) {
                // Blocked by upstream failure
                $stage.addClass('rejected'); // Use rejected style for blocked
                $card.addClass('rejected');
                $badge.addClass('rejected').text('Blocked');
                $output.addClass('error').text('â›” Upstream failed');
              } else {
                // Success
                $stage.addClass('resolved');
                $card.addClass('resolved');
                $badge.addClass('resolved').text('Done');
                
                try {
                  $output.text(format(value));
                } catch (e) {
                  $output.text('â€”');
                }
              }
              break;
          }
        });
      });

      // --- Controls ---
      $('#btnSuccess').on('click', () => {
        shouldFail.value = false;
        runId.value++;
      });

      $('#btnFail').on('click', () => {
        shouldFail.value = true;
        runId.value++;
      });
    </script>
  </body>
</html>
